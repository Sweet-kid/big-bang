{% extends 'layout-planet' %}
{% block body %}
            <div class="span8 box"><!-- left column (Feed Management) -->
                <h3>Edit Planet Feeds</h3>
                <a class="btn btn-small btn-success" id="feedbtn-add" onclick='add_feed()'><i class="icon-plus icon-white"></i> Add</a> and <a class="btn btn-small btn-danger" href="#"><i class="icon-white icon-remove"></i> Remove</a> feeds as needed.</p>
                <form class="feed-form">
                    <div class="form-inline">
                        When finished making changes, be sure to save them: <input type="password" class="input-small" placeholder="Password"> <a class="btn btn-success submit-button" onclick="save()" title="Save all changes">Save</a>
                    </div> <!-- / .form-inline -->

                    <div style="display: none" id="template-feed-form"><!-- template for form box that adds a single feed -->
                        <div class="single-feed box" id="feed">
                            <div class="image-holder">
                                <img src="http://i.imgur.com/xXWG7.jpg" class="img-rounded">
                            </div>
                            <a class="btn btn-mini btn-danger feedbtn-rm" id="rm" title="Remove this feed"><i class="icon-white icon-remove"></i></a>
                            <fieldset>
                                <label>Feed Name</label>
                                <input type="text" id="feed-name" name="feed-name" placeholder="Blog author or title" required>
                                <span class="help-block">This will be displayed at the top of the blog's entries and in the list of feeds.</span>

                                <label>Feed URL</label>
                                <input type="text" id="feed-url" name="feed-url" placeholder="http://blog-url.com/rss.xml" required>

                                <label>Image URL (optional)</label>
                                <input type="text" id="feed-img" name="feed-img" placeholder="http://">
                                <span class="help-block">Image must be 150-250px wide.</span>
                            </fieldset>
                        </div> <!-- / .single-feed -->
                    </div> <!-- / template -->

                    <div id="all-feeds"><!-- added feeds will be inserted in this div -->
                    </div> <!-- / all feeds wrapper -->

                </form> <!-- / feed form -->
            </div><!-- / .span8 (feed management column) -->

            <div class="span4"> <!-- Right Column -->
                <div id="config-form" class="sidebar box"> <!-- Planet Config Form -->
                    <h4>Edit Planet Configuration</h4>
                    <form class="feed-form">
                        <fieldset>
                            <label>Planet Name</label>
                            <input type="text">
                            <span class="help-block">This will be the heading that appears at the top of your Planet's feed.</span>

                            <label>Planet Administrator(s)</label>
                            <input type="text">
                            <span class="help-block">Name of the administrator (if there is more than one, list all names, separated with commas).</span>

                            <label>Administrator Email</label>
                            <input type="text">
                            <span class="help-block">This email address is viewable by anybody who comes to this page or pulls the planet's feed. You might consider using something other than your personal email account.</span>

                            <label>Change Password</label>
                            <input type="text" placeholder="New password">
                        </fieldset>
                        <hr>
                            <label class="text-error">Save Configuration Changes:</label>
                            <input type="password" class="input-small" placeholder="Current Password"> <button type="submit" class="btn btn-success">Save</button>
                    </form>
                </div> <!--/ .sidebar .box #config-form-->
            </div><!-- / .span4 (right column) -->
<script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
<!--<script type="text/javascript" src="/static/js/jquery.validate.1.11.1.min.js"></script>-->
<script type="text/javascript">

var highest_feed_id = 0; // this is set in load_data_feed() from json data, updated with each save
var next_id = highest_feed_id + 1; // next ID # to be assigned to a brand new feed (reset once highest_feed_id is set from json data)
var planetname = 'wfs' // {{ planetname }} - troubleshoot this version; being passed through w/out quotes; js is interpreting it as a variable
var feeds_loaded = 1

$(document).ready(function() 
{
    $( ".feedbtn-rm" ).click(del_feed);
    load_feeds();
    // if there are no feeds, load a single-feed box:
    if (feeds_loaded == 0)
    {
        add_feed(next_id);
    }
    console.log("Ready!");
});

function add_feed(id)
{
    // clone the hidden template and make it visible
    $("#template-feed-form").children().clone(true).prependTo("#all-feeds");
    // specify default ID (when onclick is used):
    if (typeof id === "undefined") {
        id = next_id;
    }
    // add unique feed ID # to each field's id & name: feed-name, feed-url, feed-img
    $("#all-feeds #feed").attr("id", "feed-" + id);
    $("#all-feeds #feed-name").attr("id", "feed-name-" + id);
    $("#all-feeds #feed-name").attr("name", "feed-name-" + id);
    $("#all-feeds #feed-url").attr("id", "feed-url-" + id);
    $("#all-feeds #feed-url").attr("name", "feed-url-" + id);
    $("#all-feeds #feed-img").attr("id", "feed-img-" + id);
    $("#all-feeds #feed-img").attr("name", "feed-img-" + id);

    // if id is a new one, increment the global id count:
    
    if (id > highest_feed_id)
    {
        console.log("highest_feed_id = " + highest_feed_id)
        next_id++;
        console.log("added new feed window")
    }

}

function del_feed()
{
    // todo: store deleted feed info to cross-reference with planet database and delete from existing database.
    // another way to do this is to simply remove it from the dom and completely overwrite the database each save with only the feeds that are in the dom.
    $(this).parent().remove();
}

function load_feeds()
{
    // load all existing feeds when the page loads
    // first, use ajax to get the saved feeds
    $.ajax({
            url: "/ws/planet/" + encodeURIComponent('wfs'), // todo: pass in planetname variable
            dataType : "json", 
            success: function(json)
            {
                load_feed_data(json);
                console.log("all feeds loaded from database.");
            },
            error: function(xhr, txtStatus, errorThrown) // todo: fix error handling to integrate with existing Planeteria code
            {
                console.log("Failed to load planet feeds. Status: " + xhr.status);
            }
    });
}

function load_feed_data(json)
{
    // set globals from json data
    console.log("Loading feeds...");
    highest_feed_id = json['highest_feed_id'];
    next_id = highest_feed_id + 1;
    var feed_list = json['feeds'];
    var num_feeds = $(feed_list).size();
    console.log("Found "+num_feeds+" feeds to load.");
    for (i = 0; i < num_feeds; i++) 
    {
        var feed_id = feed_list[i]['id'];
        // add a new .single-feed box div with feed fields using the feed's unique id
        add_feed(feed_id);
        // populate fields with feed data
        $("#feed-name-" + feed_id).val(feed_list[i]['name']);
        $("#feed-url-" + feed_id).val(feed_list[i]['url']);
        $("#feed-img-").val(feed_list[i]['image']);
    }
    feeds_loaded = num_feeds
}


function save()
{
    // todo: add form validation
    // todo: confirm password
    
    console.log("Saving feeds...");
    var feeds_to_save = [];
    $("#all-feeds").children().each(function(index) {
        var feed_id = $(this).attr('id');
        console.log("Feed ID:" + feed_id);
        var id = feed_id.replace(/[^0-9]/g, ''); // strip non-numeric characters from feed ID to get the #
        console.log("number:" + id);
        feed = {};  // builds dictionary (hash) with data from a single feed
        feed['id'] = id;
        feed['url'] = $("#feed-url-" + id).val();
        feed['name'] = $("#feed-name-" + id).val();
        feed['image'] = $("#feed-img-" + id).val();
        console.log(feed);
        // add each new feed to the list of feeds
        feeds_to_save.push(feed);
        highest_feed_id = next_id
    });

    $.ajax({
            url: "/ws/planet/" + encodeURIComponent('wfs'),
            type: "POST", 
            data : JSON.stringify({'planetname':planetname, 'feeds':feeds_to_save, 'highest_feed_id':highest_feed_id}), 
            dataType : "json", 
            contentType: "application/json; charset=utf-8", 
            success: function(json)
            {
                console.log("saved all feeds.");
            },
            error: function(xhr, txtStatus, errorThrown) // todo: fix error handling to integrate with existing Planeteria code
            {
                console.log("Failed to save planet feeds. Status: " + xhr.status);
            }
    });

}
</script>
{% endblock %}